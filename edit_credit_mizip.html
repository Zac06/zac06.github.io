<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css">

    <title>MiZip credit editor</title>

    <script>
        function isHex(str) {
            return /^[0-9A-Fa-f]+$/.test(str);
        }

        function calculate(){
            const sector=document.forms['calculator'].sector.value;
            const blocks=sector.split(/\r?\n/);

            if(document.forms['calculator'].credit.value===''){
                alert('Please insert a new credit value.');
                return false;
            }

            let newcred=parseFloat(document.forms['calculator'].credit.value);
            newcred*=100;
            newcred=Math.round(newcred);

            for(let i=0; i<blocks.length; i++){
                if(blocks[i]===''){
                    blocks.splice(i, 1);
                    i--;
                }
            }

            //console.log(blocks);

            if(blocks.length!=3){
                alert('Please insert the 3 sectors required.');
                return false;
            }

            //console.log(newcred);
            if(newcred<0||newcred>65535){
                alert('Please insert a new credit value between 0 and 655.35.');
                return false;
            }

            if(!(isHex(blocks[0])&&isHex(blocks[1])&&isHex(blocks[2])
                &&blocks[0].length==32&&blocks[1].length==32&&blocks[2].length==32)){
                    alert('Please insert 3 hex sectors, 16 bytes each (32 hex characters).');
                    return false;
            }


            const block_0 = new Uint8Array(
                blocks[0].match(/.{2}/g).map(byte => parseInt(byte, 16))
            );
            const block_1 = new Uint8Array(
                blocks[1].match(/.{2}/g).map(byte => parseInt(byte, 16))
            );
            const block_2 = new Uint8Array(
                blocks[2].match(/.{2}/g).map(byte => parseInt(byte, 16))
            );

            let block0_price=block_0[2]<<8 | block_0[1];
            let block0_xor=block_0[3];
            let block0_opno=block_0[15];

            let block1_price=block_1[2]<<8 | block_1[1];
            let block1_xor=block_1[3];
            let block1_opno=block_1[15];

            let block2_curr=block_2[0];
            let block2_cur_opno=block_2[1];
            let curcred;
            let newxor=(newcred&0xFF)^(newcred>>8);

            if(block2_cur_opno==block0_opno){
                curcred=block0_price/100;
            }else{
                curcred=block1_price/100;
            }

            if(confirm(`The current credit is ${curcred}. Do you wish to continue?`)){
                block2_cur_opno++;
                block2_cur_opno&=0xFF;

                if(block2_curr==0x55){
                    block0_opno=block2_cur_opno;
                    block0_price=newcred;
                    block0_xor=newxor;

                    block2_curr=0xAA;
                }else{
                    block1_opno=block2_cur_opno;
                    block1_price=newcred;
                    block1_xor=newxor;

                    block2_curr=0x55;
                }
            }

            let outstring='';
            
            outstring+='00';
            let lsb=block0_price&0xFF;
            let hsb=(block0_price>>8)&0xFF;
            outstring+=lsb.toString(16).toUpperCase().padStart(2, '0');
            outstring+=hsb.toString(16).toUpperCase().padStart(2, '0');
            outstring+=block0_xor.toString(16).toUpperCase().padStart(2, '0');
            outstring+='0000000000000000000000';
            outstring+=block0_opno.toString(16).toUpperCase().padStart(2, '0');
            outstring+='\n';

            outstring+='00';
            lsb=block1_price&0xFF;
            hsb=(block1_price>>8)&0xFF;
            outstring+=lsb.toString(16).toUpperCase().padStart(2, '0');
            outstring+=hsb.toString(16).toUpperCase().padStart(2, '0');
            outstring+=block1_xor.toString(16).toUpperCase().padStart(2, '0');
            outstring+='0000000000000000000000';
            outstring+=block1_opno.toString(16).toUpperCase().padStart(2, '0');
            outstring+='\n';

            outstring+=block2_curr.toString(16).toUpperCase().padStart(2, '0');
            outstring+=block2_cur_opno.toString(16).toUpperCase().padStart(2, '0');
            outstring+='0000000000000000000000000000';

            document.forms['calculator'].sector.value=outstring;

            return false;
        }
    </script>
</head>

<body>
    <div class="topbox" id="topbox">
        <div class="username">MiZip Credit Editor</div>

        <div class="description">
            This tool is an online demo which provides a quick way to edit the credit data contained in MiZip vending
            machines keys.
            <a href="http://github.com/Zac06/edit_credit_mizip" target="_blank">Go to the source</a>
        </div> 

    </div>

    <div class="centralbox">
        <div class="content" id="content">
            <div class="project">
                <form name="calculator" onsubmit="return calculate()">
                    <div class="description">
                        Input your MiZip key Sector 2 here (3 blocks)
                    </div>
                    <br>
                    <textarea class="glass_tile mizip_input" name="sector" rows="3" cols="32"
                        placeholder="3 rows, 16 hex bytes each"></textarea>
                    <br><br>
                    <div class="description">
                        Input your new credit here (max. 655.35)
                    </div>
                    <br>
                    <input type="number" name="credit" class="glass_tile mizip_input" step="0.01"
                        placeholder="Put the new credit here..." min="0" max="655.35">
                    <br><br>
                    <input type="submit" value="Calculate" class="glass_tile mizip_input">
                    <br><br>
                    <input type="reset" value="Reset" class="glass_tile mizip_input">
                </form>
            </div>


        </div>
    </div>

    <div class="footer">
        <div class="description">
            Links
        </div>
        <div class="footer_content">
            <a href="http://github.com/" target="_blank">
                <div class="glass_tile github"></div>
            </a>

        </div>
    </div>

</body>

</html>